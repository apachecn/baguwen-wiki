<!--yml
category: 未分类
date: 0001-01-01 00:00:00
--->

# 说一下Java对象的创建过程

> 原文：[https://zwmst.com/455.html](https://zwmst.com/455.html)

   [ *Java虚拟机* ](https://zwmst.com/java%e8%99%9a%e6%8b%9f%e6%9c%ba)*[ <time datetime="2021-08-14T06:49:48+08:00"> 2021-08-13 </time> ](https://zwmst.com/455.html)  1）类加载检查： 虚拟机遇到一条 new 指令时，首先将去检查这个指令的参数是否能在常量池 中定位到这个类的符号引用，并且检查这个符号引用代表的类是否已被加载过、解析和初始化 过。如果没有，那必须先执行相应的类加载过程。

2）分配内存： 在类加载检查通过后，接下来虚拟机将为新生对象分配内存。对象所需的内存 大小在类加载完成后便可确定，为对象分配空间的任务等同于把一块确定大小的内存从 Java 堆中划分出来。分配方式有 “指针碰撞” 和 “空闲列表” 两种，选择那种分配方式由 Java 堆是 否规整决定，而Java堆是否规整又由所采用的垃圾收集器是否带有压缩整理功能决定。

选择以上2种方式中的哪一种，取决于 Java 堆内存是否规整。而 Java 堆内存是否规整，取决 于 GC 收集器的算法是"标记-清除"，还是"标记-整理"（也称作"标记-压缩"），值得注意的 是，复制算法内存也是规整的。

在创建对象的时候有一个很重要的问题，就是线程安全，因为在实际开发过程中，创建对象是 很频繁的事情，作为虚拟机来说，必须要保证线程是安全的，通常来讲，虚拟机采用两种方式 来保证线程安全： CAS+失败重试： CAS 是乐观锁的一种实现方式。所谓乐观锁就是，每次不加锁而是假设没有 冲突而去完成某项操作，如果因为冲突失败就重试，直到成功为止。虚拟机采用 CAS 配上失败 重试的方式保证更新操作的原子性。 TLAB： 为每一个线程预先在Eden区分配一块儿内存，JVM在给线程中的对象分配内存时，首 先在TLAB分配，当对象大于TLAB中的剩余内存或TLAB的内存已用尽时，再采用上述的CAS 进行内存分配

3）初始化零值： 内存分配完成后，虚拟机需要将分配到的内存空间都初始化为零值（不包括 对象头），这一步操作保证了对象的实例字段在 Java 代码中可以不赋初始值就直接使用，程 序能访问到这些字段的数据类型所对应的零值。

4）设置对象头： 初始化零值完成之后，虚拟机要对对象进行必要的设置，例如这个对象是那 个类的实例、如何才能找到类的元数据信息、对象的哈希吗、对象的 GC 分代年龄等信息。 这 些信息存放在对象头中。 另外，根据虚拟机当前运行状态的不同，如是否启用偏向锁等，对象 头会有不同的设置方式。

5）执行 init 方法： 在上面工作都完成之后，从虚拟机的视角来看，一个新的对象已经产生 了，但从 Java 程序的视角来看，对象创建才刚开始，init 方法还没有执行，所有的字段都还 为零。所以一般来说，执行 new 指令之后会接着执行 init 方法，把对象按照程序员的意愿进 行初始化，这样一个真正可用的对象才算完全产生出来。*